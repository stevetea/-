# 调试 500 错误

## 问题

接口返回 500 错误，说明服务器内部错误。

## 可能的原因

1. **数据库表不存在** - 工序表可能还没有创建
2. **SQL 语法错误** - 查询语句有问题
3. **数据库连接问题** - 连接池配置错误
4. **数据为空时的处理** - 没有处理空数据情况

## 已做的修复

1. ✅ 优化了 SQL 查询，使用 `IN` 子查询替代 `INNER JOIN`
2. ✅ 添加了空数据检查（`records || []`）
3. ✅ 改进了错误处理，输出详细错误信息
4. ✅ 添加了请求日志，方便调试

## 调试步骤

### 1. 查看后端控制台错误

后端控制台会显示详细的错误信息，包括：
- 错误消息
- 错误堆栈
- SQL 查询语句

### 2. 检查数据库表是否存在

运行以下 SQL 检查表是否存在：

```sql
-- 检查工序表
SHOW TABLES LIKE 'proc_%';

-- 检查 blade 表
SHOW TABLES LIKE 'blade';

-- 检查是否有数据
SELECT COUNT(*) FROM blade;
SELECT COUNT(*) FROM proc_alloy_preheat;
```

### 3. 测试数据库连接

```bash
cd backend
node test-db.js
```

### 4. 检查后端日志

查看后端控制台输出，应该能看到：
- 请求路径和参数
- 错误详情
- SQL 错误信息

## 临时解决方案

如果数据库表还没有创建或没有数据，接口会返回空列表，这是正常的。

如果确实需要数据，可以：
1. 运行 `traceability_schema.sql` 创建表
2. 插入测试数据
3. 重新测试接口

## 常见错误

### 错误 1: Table doesn't exist

**错误信息**：`Table 'traceability.proc_alloy_preheat' doesn't exist`

**解决**：运行 SQL 脚本创建表

### 错误 2: Column doesn't exist

**错误信息**：`Unknown column 'xxx' in 'field list'`

**解决**：检查表结构，确保字段名正确

### 错误 3: Connection error

**错误信息**：`Connection lost` 或 `ECONNREFUSED`

**解决**：检查数据库服务是否运行，检查 `.env` 配置

## 下一步

1. 查看后端控制台的详细错误信息
2. 根据错误信息修复问题
3. 如果表不存在，运行 SQL 脚本创建表
4. 如果表存在但没有数据，这是正常的，接口会返回空列表

