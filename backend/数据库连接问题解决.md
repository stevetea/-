# 数据库连接问题解决指南

## 错误信息

```
❌ 数据库连接失败: Access denied for user 'root'@'localhost' (using password: YES)
```

## 可能的原因

1. **密码错误** - `.env` 文件中的密码不正确
2. **用户不存在** - MySQL 中没有 `root` 用户
3. **权限问题** - 用户没有访问权限
4. **MySQL 服务未启动** - MySQL 服务没有运行
5. **端口错误** - MySQL 端口不是 3306

## 解决步骤

### 步骤 1：检查 MySQL 服务是否运行

**Windows:**
```powershell
# 检查 MySQL 服务状态
Get-Service -Name MySQL*

# 如果未运行，启动服务
Start-Service -Name MySQL80  # 根据你的 MySQL 版本调整
```

**Linux/Mac:**
```bash
# 检查 MySQL 服务状态
sudo systemctl status mysql
# 或
sudo service mysql status

# 如果未运行，启动服务
sudo systemctl start mysql
```

### 步骤 2：检查 MySQL 密码

#### 方法一：使用命令行测试连接

```bash
# Windows (在命令提示符中)
mysql -u root -p

# Linux/Mac
mysql -u root -p
```

输入密码，如果能连接成功，说明密码正确。

#### 方法二：重置 MySQL root 密码（如果忘记密码）

**Windows:**
1. 停止 MySQL 服务
2. 以管理员身份打开命令提示符
3. 使用 `--skip-grant-tables` 启动 MySQL
4. 重置密码

**Linux/Mac:**
```bash
sudo mysql -u root
# 或
sudo /usr/bin/mysql -u root
```

### 步骤 3：检查 .env 文件配置

确保 `backend/.env` 文件存在且配置正确：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=你的MySQL密码  # 👈 这里填写正确的密码
DB_DATABASE=traceability
```

**重要：**
- 如果 MySQL root 用户没有密码，设置为空：`DB_PASSWORD=`
- 如果密码包含特殊字符，用引号包裹：`DB_PASSWORD="your@password#123"`

### 步骤 4：创建数据库

如果数据库 `traceability` 不存在，需要先创建：

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE IF NOT EXISTS traceability 
  DEFAULT CHARACTER SET utf8mb4 
  DEFAULT COLLATE utf8mb4_0900_ai_ci;

-- 使用数据库
USE traceability;

-- 执行 SQL 文件
source D:/yepian/traceability_schema.sql
```

### 步骤 5：测试数据库连接

创建一个测试文件 `backend/test-db.js`：

```javascript
const mysql = require('mysql2/promise');
require('dotenv').config();

async function testConnection() {
  try {
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_DATABASE || 'traceability'
    });
    
    console.log('✅ 数据库连接成功！');
    await connection.end();
  } catch (error) {
    console.error('❌ 数据库连接失败:', error.message);
    console.log('\n请检查：');
    console.log('1. MySQL 服务是否运行');
    console.log('2. .env 文件中的配置是否正确');
    console.log('3. 数据库用户密码是否正确');
  }
}

testConnection();
```

运行测试：
```bash
node test-db.js
```

## 常见解决方案

### 方案 1：使用空密码（不推荐，仅开发环境）

如果 MySQL root 用户没有密码：

```env
DB_PASSWORD=
```

### 方案 2：创建新用户（推荐）

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建新用户
CREATE USER 'traceability'@'localhost' IDENTIFIED BY 'your_password';

-- 授予权限
GRANT ALL PRIVILEGES ON traceability.* TO 'traceability'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;
```

然后在 `.env` 中使用新用户：

```env
DB_USER=traceability
DB_PASSWORD=your_password
```

### 方案 3：检查 MySQL 端口

如果 MySQL 使用非标准端口：

```env
DB_PORT=3307  # 或其他端口
```

查看 MySQL 端口：
```sql
SHOW VARIABLES LIKE 'port';
```

## 快速检查清单

- [ ] MySQL 服务正在运行
- [ ] `.env` 文件存在且配置正确
- [ ] 数据库密码正确
- [ ] 数据库 `traceability` 已创建
- [ ] 用户有访问权限
- [ ] 端口号正确（默认 3306）

## 如果还是不行

1. **查看详细错误信息**：修改 `config/database.js` 添加更详细的错误日志
2. **检查 MySQL 日志**：查看 MySQL 错误日志
3. **使用 MySQL Workbench**：图形化工具测试连接
4. **检查防火墙**：确保端口 3306 没有被阻止

