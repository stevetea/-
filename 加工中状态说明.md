# 叶片"加工中"状态说明

## 一、"加工中"的概念

**加工中（IN_PROCESS）**是指叶片已经开始进入生产流程，正在执行加工工序的状态。这是叶片从"新建"到"完成"之间的主要工作状态。

## 二、"加工中"状态的触发条件

### 1. 主要触发条件：工序录入成功

**当操作员录入工序并成功时，系统自动将叶片状态更新为"加工中"：**

```javascript
// backend/routes/process.js 第123-128行
if (is_success) {
  // 成功：更新为加工中
  await pool.execute(
    'UPDATE blade SET status = ? WHERE blade_id = ?',
    ['IN_PROCESS', blade_id]
  );
}
```

**触发场景：**
- ✅ 操作员录入任何一道工序
- ✅ 工序执行结果选择"成功"（`is_success = 1`）
- ✅ 系统自动将状态从 `NEW` 更新为 `IN_PROCESS`
- ✅ 或者从 `BLOCKED` 更新为 `IN_PROCESS`（返工成功时）

### 2. 从阻塞状态恢复

**当阻塞的工序返工成功时，也会更新为"加工中"：**

```
BLOCKED（阻塞） → 返工成功 → IN_PROCESS（加工中）
```

**触发场景：**
- ✅ 叶片之前处于 `BLOCKED` 状态
- ✅ 操作员重新执行阻塞的工序
- ✅ 本次执行成功（`is_success = 1`）
- ✅ 系统自动将状态从 `BLOCKED` 更新为 `IN_PROCESS`

## 三、"加工中"状态的保持

### 1. 状态保持条件

叶片会一直保持"加工中"状态，直到：

- ✅ **所有工序完成** → 更新为 `READY_FOR_QC`（待质检）
- ❌ **某道工序失败** → 更新为 `BLOCKED`（阻塞）

### 2. 状态范围

"加工中"状态覆盖以下情况：

1. **刚开始加工**：完成第1道工序后
2. **加工进行中**：完成部分工序（如第2、3、4...步）
3. **接近完成**：完成前10道工序，等待最后一道工序
4. **返工恢复**：从阻塞状态恢复后继续加工

## 四、状态转换流程图

```
新建（NEW）
    ↓
[录入第1道工序成功]
    ↓
加工中（IN_PROCESS） ← ─ ─ ─ ─ ┐
    ↓                          │
[录入第2道工序成功]            │
    ↓                          │
加工中（IN_PROCESS）           │
    ↓                          │
[录入第3道工序成功]            │
    ↓                          │
加工中（IN_PROCESS）           │
    ↓                          │
...（继续加工）                │
    ↓                          │
[某道工序失败]                 │
    ↓                          │
阻塞（BLOCKED）                │
    ↓                          │
[返工成功] ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
    ↓
加工中（IN_PROCESS）
    ↓
[完成所有11道工序]
    ↓
待质检（READY_FOR_QC）
```

## 五、代码实现

### 1. 工序成功时的处理

**位置**：`backend/routes/process.js` 第123-140行

```javascript
if (is_success) {
  // 1. 更新叶片状态为加工中
  await pool.execute(
    'UPDATE blade SET status = ? WHERE blade_id = ?',
    ['IN_PROCESS', blade_id]
  );
  
  // 2. 更新工序状态表
  await pool.execute(
    `INSERT INTO blade_process_state (
      blade_id,
      current_success_order,  // 当前成功完成的工序顺序号
      last_process_code,      // 最后记录的工序编码
      is_blocked,             // 设置为0（正常）
      updated_at
    ) VALUES (?, ?, ?, 0, NOW())
    ON DUPLICATE KEY UPDATE 
      current_success_order = ?,
      last_process_code = ?,
      is_blocked = 0,        // 清除阻塞状态（如果是返工）
      updated_at = NOW()`,
    [
      blade_id,
      processDef.process_order,  // 当前工序顺序号
      process_code,              // 当前工序编码
      processDef.process_order,
      process_code
    ]
  );
}
```

### 2. 初始状态

**新建叶片时的初始状态**：`NEW`（新建）

```javascript
// backend/routes/blade.js 第138行
'INSERT INTO blade (blade_sn, status, created_at, updated_at) VALUES (?, ?, NOW(), NOW())',
[blade_sn, 'NEW']  // 初始状态为 NEW
```

## 六、示例场景

### 场景1：新叶片开始加工

1. **创建叶片**
   - 叶片ID：12
   - 初始状态：`NEW`（新建）

2. **录入第1道工序（合金预热）**
   - 工序执行：成功
   - 系统自动更新：
     - 状态：`NEW` → `IN_PROCESS`（加工中）
     - `current_success_order = 1`

3. **继续录入第2道工序（冲压成型冷却）**
   - 工序执行：成功
   - 系统保持状态：
     - 状态：`IN_PROCESS`（加工中）
     - `current_success_order = 2`

### 场景2：从阻塞恢复

1. **叶片处于阻塞状态**
   - 叶片ID：8
   - 状态：`BLOCKED`（阻塞）
   - 阻塞在第4步

2. **返工第4步工序**
   - 重新执行"涂陶瓷漆涂层加热"
   - 本次执行：成功

3. **系统自动恢复**
   - 状态：`BLOCKED` → `IN_PROCESS`（加工中）
   - `is_blocked = 0`（清除阻塞标记）
   - `current_success_order = 4`

### 场景3：加工进行中

1. **叶片正在加工**
   - 叶片ID：6
   - 状态：`IN_PROCESS`（加工中）
   - 已完成：第1-5步工序
   - 待完成：第6-11步工序

2. **继续录入工序**
   - 每次工序成功，状态保持为 `IN_PROCESS`
   - `current_success_order` 逐步增加

3. **完成所有工序**
   - 完成第11步工序后
   - 状态：`IN_PROCESS` → `READY_FOR_QC`（待质检）

## 七、"加工中"状态的特点

### 1. 状态特点

- ✅ **动态状态**：随着工序进展而保持
- ✅ **中间状态**：从新建到完成之间的过渡状态
- ✅ **可恢复状态**：从阻塞恢复后回到此状态
- ✅ **持续状态**：可以持续很长时间（直到所有工序完成）

### 2. 业务意义

- 📊 **进度跟踪**：标识叶片正在加工中
- 🔄 **流程管理**：区分未开始、进行中、已完成
- 📈 **统计分析**：统计正在加工的叶片数量
- 🎯 **工作分配**：操作员可以看到需要加工的叶片

## 八、状态转换规则总结

| 当前状态 | 操作 | 结果状态 | 说明 |
|---------|------|---------|------|
| `NEW` | 录入工序成功 | `IN_PROCESS` | 开始加工 |
| `IN_PROCESS` | 录入工序成功 | `IN_PROCESS` | 继续加工 |
| `IN_PROCESS` | 录入工序失败 | `BLOCKED` | 阻塞 |
| `BLOCKED` | 返工成功 | `IN_PROCESS` | 恢复加工 |
| `IN_PROCESS` | 完成所有工序 | `READY_FOR_QC` | 待质检 |

## 九、关键代码位置

- **后端实现**：`backend/routes/process.js` 第123-140行
- **状态定义**：`utils/config.js` 第29行
- **数据库默认值**：`traceability_schema.sql` 第35行
- **说明文档**：已创建 `加工中状态说明.md`

## 十、注意事项

1. **自动更新**：状态由系统根据工序录入结果自动更新，无需手动设置
2. **成功即更新**：任何工序成功都会触发状态更新为"加工中"
3. **持续保持**：只要还有未完成的工序，状态就会保持为"加工中"
4. **阻塞恢复**：从阻塞状态恢复后，会回到"加工中"状态
5. **完成转换**：完成所有工序后，自动转换为"待质检"状态

## 十一、总结

**"加工中"状态的触发条件：**

1. ✅ **工序录入成功**：任何一道工序执行成功时
2. ✅ **从阻塞恢复**：阻塞工序返工成功时

**"加工中"状态的特点：**

- 🔄 动态状态，随工序进展保持
- 📊 用于标识叶片正在加工
- ✅ 可以持续到所有工序完成
- 🔄 可以从阻塞状态恢复到此状态

**"加工中"状态的转换：**

- `NEW` → `IN_PROCESS`（开始加工）
- `IN_PROCESS` → `IN_PROCESS`（继续加工）
- `BLOCKED` → `IN_PROCESS`（返工恢复）
- `IN_PROCESS` → `READY_FOR_QC`（完成所有工序）
- `IN_PROCESS` → `BLOCKED`（工序失败）

