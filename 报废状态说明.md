# 叶片报废状态说明

## 一、报废的概念

**报废（SCRAPPED）**是指叶片在完成所有加工工序后，经过最终质检判定为不合格，且无法修复或返工，需要报废处理的状态。报废是叶片的最终状态，一旦标记为报废，叶片将不再进入生产流程。

## 二、报废的触发条件

### 唯一触发条件：质检不通过

**报废只在以下情况下自动触发：**

1. **叶片已完成所有11道工序**（状态为 `READY_FOR_QC`）
2. **质检员进行最终质检**
3. **质检结果选择"不通过"**（`result = 'FAIL'`）
4. **系统自动将叶片状态更新为 `SCRAPPED`**

## 三、报废的实现机制

### 1. 代码实现位置

**后端代码**：`backend/routes/qc.js` 第78-83行

```javascript
// 提交质检报告后，根据结果更新叶片状态
const newStatus = result === 'PASS' ? 'COMPLETED' : 'SCRAPPED';
await pool.execute(
  'UPDATE blade SET status = ? WHERE blade_id = ?',
  [newStatus, blade_id]
);
```

### 2. 状态转换流程

```
所有工序完成 → READY_FOR_QC（待质检）
                    ↓
              质检员进行质检
                    ↓
        ┌───────────┴───────────┐
        ↓                       ↓
    result='PASS'          result='FAIL'
        ↓                       ↓
   COMPLETED              SCRAPPED
   （完成）                （报废）
```

### 3. 关键判断逻辑

```javascript
// 在 POST /api/qc 接口中
if (result === 'PASS') {
  // 质检通过 → 状态更新为 COMPLETED（完成）
  newStatus = 'COMPLETED';
} else {
  // 质检不通过 → 状态更新为 SCRAPPED（报废）
  newStatus = 'SCRAPPED';
}
```

## 四、报废的业务规则

### 1. 前置条件

- ✅ 叶片必须完成所有11道工序
- ✅ 叶片状态必须为 `READY_FOR_QC`（待质检）
- ✅ 必须由质检员（QC）或管理员（ADMIN）进行质检

### 2. 质检判定标准

质检员在质检时会检查：

1. **质检结论**：通过（PASS）或不通过（FAIL）
2. **尺寸检查**：合格/不合格
3. **外观/表面检查**：合格/不合格
4. **测量数据**：重量、关键尺寸等
5. **缺陷等级**（不通过时必填）：
   - NONE：无
   - MINOR：轻微
   - MAJOR：严重
   - CRITICAL：致命
6. **不合格单号**（可选）

### 3. 报废的判定

**以下情况会导致报废：**

- 质检结论选择"不通过"（`result = 'FAIL'`）
- 可能的原因包括：
  - 尺寸严重超标，无法修复
  - 外观缺陷严重
  - 关键参数不达标
  - 存在致命缺陷（CRITICAL）

## 五、报废与阻塞的区别

| 特性 | 阻塞（BLOCKED） | 报废（SCRAPPED） |
|------|----------------|-----------------|
| **触发时机** | 加工过程中，某道工序失败 | 所有工序完成后，质检不通过 |
| **是否可以恢复** | ✅ 可以（返工后继续） | ❌ 不可以（最终状态） |
| **状态位置** | 加工流程中 | 流程结束后 |
| **处理方式** | 重新执行失败工序 | 报废处理，不再生产 |
| **记录位置** | `blade_process_state` 表 | `blade` 表 + `qc_inspection` 表 |

## 六、报废信息的记录

### 1. 叶片主表（blade）

```sql
UPDATE blade SET status = 'SCRAPPED' WHERE blade_id = ?
```

### 2. 质检记录表（qc_inspection）

记录详细的质检信息：

```sql
INSERT INTO qc_inspection (
  blade_id,
  inspector_id,        -- 质检员ID
  result,              -- 'FAIL'
  dimension_pass,      -- 尺寸检查结果
  surface_pass,        -- 外观检查结果
  weight_g,            -- 重量
  key_dimension_mm,    -- 关键尺寸
  defect_level,        -- 缺陷等级（CRITICAL/MAJOR/MINOR）
  ncr_no,              -- 不合格单号
  remarks              -- 备注（如：尺寸严重超标，无法修复）
) VALUES (...)
```

## 七、报废后的处理

### 1. 系统行为

- ✅ 叶片状态永久标记为 `SCRAPPED`
- ✅ 不再出现在待质检列表中
- ✅ 不再出现在可录入工序的列表中
- ✅ 可以查看追溯信息（只读）
- ✅ 在统计中计入报废数量

### 2. 业务处理

- 📋 根据不合格单号（NCR）进行后续处理
- 📊 统计报废原因，用于质量分析
- 🔍 追溯报废叶片的完整加工历史
- 📈 分析报废率，改进生产工艺

## 八、示例场景

### 场景：叶片质检不通过，标记为报废

1. **叶片完成所有工序**
   - 叶片ID：10
   - 已完成11道工序
   - 状态：`READY_FOR_QC`

2. **质检员进行质检**
   - 质检结论：不通过（FAIL）
   - 尺寸检查：不合格
   - 缺陷等级：CRITICAL（致命）
   - 不合格单号：NCR-20251226-001
   - 备注：尺寸严重超标，无法修复

3. **系统自动处理**
   ```sql
   -- 更新叶片状态为报废
   UPDATE blade SET status = 'SCRAPPED' WHERE blade_id = 10;
   
   -- 保存质检记录
   INSERT INTO qc_inspection (
     blade_id, inspector_id, result, defect_level, ncr_no, remarks
   ) VALUES (
     10, 5, 'FAIL', 'CRITICAL', 'NCR-20251226-001', '尺寸严重超标，无法修复'
   );
   ```

4. **结果**
   - 叶片状态：`SCRAPPED`（报废）
   - 不再进入生产流程
   - 可以查看完整追溯信息

## 九、关键代码位置

- **后端实现**：`backend/routes/qc.js` 第78-83行
- **数据库表**：
  - `blade` 表：`status` 字段
  - `qc_inspection` 表：质检记录
- **前端显示**：
  - `pages/trace-detail/trace-detail.vue`：显示报废状态
  - `pages/statistics/statistics.vue`：统计报废数量
- **状态映射**：`utils/config.js` 第33行

## 十、注意事项

1. **报废是最终状态**：一旦标记为报废，无法再恢复或继续加工
2. **只能通过质检设置**：报废只能由质检员在最终质检时设置，不能手动修改
3. **必须填写缺陷信息**：不通过时必须选择缺陷等级
4. **记录完整信息**：报废时会记录详细的质检信息，便于追溯和分析
5. **统计用途**：报废数据用于质量分析和工艺改进

## 十一、与阻塞的对比示例

### 阻塞示例（可恢复）
- 第4步"涂陶瓷漆涂层加热"失败
- 状态：`BLOCKED`
- 处理：重新执行第4步，成功后继续流程

### 报废示例（不可恢复）
- 所有11步工序都完成
- 最终质检不通过（尺寸严重超标）
- 状态：`SCRAPPED`
- 处理：报废，不再生产

## 十二、总结

**报废的唯一触发条件：**
- ✅ 叶片完成所有工序（状态为 `READY_FOR_QC`）
- ✅ 质检员进行最终质检
- ✅ 质检结果选择"不通过"（`result = 'FAIL'`）
- ✅ 系统自动将状态更新为 `SCRAPPED`

**报废的特点：**
- 🔒 最终状态，不可恢复
- 📋 记录详细的质检信息
- 📊 用于质量统计和分析
- 🔍 可追溯完整加工历史

