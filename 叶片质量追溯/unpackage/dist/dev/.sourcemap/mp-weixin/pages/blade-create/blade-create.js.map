{"version":3,"file":"blade-create.js","sources":["pages/blade-create/blade-create.vue","F:/Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYmxhZGUtY3JlYXRlL2JsYWRlLWNyZWF0ZS52dWU"],"sourcesContent":["<template>\r\n  <view class=\"create-container\">\r\n    <view class=\"form-card\">\r\n      <view class=\"card-title\">创建新叶片</view>\r\n      \r\n      <!-- 表单 -->\r\n      <view class=\"form-section\">\r\n        <view class=\"input-group\">\r\n          <text class=\"input-label\">叶片序列号 *</text>\r\n          <input \r\n            class=\"input\" \r\n            v-model=\"form.blade_sn\" \r\n            placeholder=\"请输入叶片序列号，例如：BLADE-001\"\r\n            maxlength=\"50\"\r\n          />\r\n        </view>\r\n      </view>\r\n      \r\n      <!-- 提交按钮 -->\r\n      <button class=\"submit-btn\" @click=\"handleSubmit\" :loading=\"submitting\">\r\n        创建叶片并生成二维码\r\n      </button>\r\n      \r\n      <!-- 创建成功后的显示 -->\r\n      <view v-if=\"createdBlade\" class=\"success-section\">\r\n        <view class=\"success-title\">✓ 创建成功</view>\r\n        <view class=\"blade-info\">\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">叶片ID：</text>\r\n            <text class=\"value\">{{ createdBlade.blade_id }}</text>\r\n          </view>\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">叶片序列号：</text>\r\n            <text class=\"value\">{{ createdBlade.blade_sn }}</text>\r\n          </view>\r\n          <view class=\"info-item\">\r\n            <text class=\"label\">状态：</text>\r\n            <text class=\"value\">{{ getStatusText(createdBlade.status) }}</text>\r\n          </view>\r\n        </view>\r\n        \r\n        <!-- 二维码显示 -->\r\n        <view class=\"qr-section\">\r\n          <view class=\"qr-title\">二维码（只存储叶片ID）</view>\r\n          <view class=\"qr-content\">{{ qrContent }}</view>\r\n          <canvas \r\n            canvas-id=\"qrcode\" \r\n            class=\"qrcode-canvas\"\r\n            :style=\"{ width: qrSize + 'px', height: qrSize + 'px' }\"\r\n          ></canvas>\r\n          <view class=\"qr-tip\">用手机扫描此二维码可查看叶片追溯信息</view>\r\n          <view class=\"qr-tip\" style=\"margin-top: 10rpx; color: #999; font-size: 24rpx;\">\r\n            提示：二维码内容为 {{ qrContent }}，您也可以使用二维码生成工具生成\r\n          </view>\r\n        </view>\r\n        \r\n        <!-- 操作按钮 -->\r\n        <view class=\"action-buttons\">\r\n          <button class=\"action-btn secondary\" @click=\"createAnother\">继续创建</button>\r\n          <button class=\"action-btn primary\" @click=\"viewTrace\">查看详情</button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { post } from '@/utils/request.js'\r\nimport storage from '@/utils/storage.js'\r\nimport { BLADE_STATUS_MAP } from '@/utils/config.js'\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      form: {\r\n        blade_sn: ''\r\n      },\r\n      submitting: false,\r\n      createdBlade: null,\r\n      qrContent: '',\r\n      qrSize: 200,\r\n      showQRText: false\r\n    }\r\n  },\r\n  onLoad() {\r\n    // 检查权限\r\n    const userInfo = storage.getUserInfo()\r\n    if (!userInfo || userInfo.role !== 'ADMIN') {\r\n      uni.showToast({\r\n        title: '无权限访问',\r\n        icon: 'none'\r\n      })\r\n      setTimeout(() => {\r\n        uni.navigateBack()\r\n      }, 1500)\r\n      return\r\n    }\r\n  },\r\n  methods: {\r\n    async handleSubmit() {\r\n      if (!this.form.blade_sn || !this.form.blade_sn.trim()) {\r\n        uni.showToast({\r\n          title: '请输入叶片序列号',\r\n          icon: 'none'\r\n        })\r\n        return\r\n      }\r\n      \r\n      this.submitting = true\r\n      \r\n      try {\r\n        const res = await post('/blade', {\r\n          blade_sn: this.form.blade_sn.trim()\r\n        })\r\n        \r\n        if (res && res.data) {\r\n          this.createdBlade = res.data\r\n          // 生成二维码内容（只存储叶片ID）\r\n          this.qrContent = `B${res.data.blade_id}`\r\n          \r\n          // 生成二维码\r\n          this.$nextTick(() => {\r\n            this.generateQRCode()\r\n          })\r\n          \r\n          uni.showToast({\r\n            title: '创建成功',\r\n            icon: 'success'\r\n          })\r\n        }\r\n      } catch (error) {\r\n        console.error('创建失败:', error)\r\n        const errorMsg = error.message || error.data?.message || '创建失败，请重试'\r\n        uni.showToast({\r\n          title: errorMsg,\r\n          icon: 'none',\r\n          duration: 2000\r\n        })\r\n      } finally {\r\n        this.submitting = false\r\n      }\r\n    },\r\n    \r\n    generateQRCode() {\r\n      // 使用在线API生成二维码图片\r\n      this.$nextTick(() => {\r\n        try {\r\n          // 创建canvas上下文\r\n          const ctx = uni.createCanvasContext('qrcode', this)\r\n          \r\n          // 使用在线API生成二维码\r\n          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${this.qrSize}x${this.qrSize}&data=${encodeURIComponent(this.qrContent)}`\r\n          \r\n          // 在canvas上绘制二维码图片\r\n          uni.downloadFile({\r\n            url: qrUrl,\r\n            success: (res) => {\r\n              if (res.statusCode === 200) {\r\n                ctx.drawImage(res.tempFilePath, 0, 0, this.qrSize, this.qrSize)\r\n                ctx.draw(false, () => {\r\n                  console.log('二维码生成成功')\r\n                  this.showQRText = false\r\n                })\r\n              } else {\r\n                this.showQRText = true\r\n              }\r\n            },\r\n            fail: () => {\r\n              // 如果在线API失败，显示文本内容\r\n              console.warn('在线二维码生成失败，显示文本内容')\r\n              this.showQRText = true\r\n            }\r\n          })\r\n        } catch (error) {\r\n          console.error('二维码生成失败:', error)\r\n          // 如果生成失败，至少显示文本内容\r\n          this.showQRText = true\r\n        }\r\n      })\r\n    },\r\n    \r\n    createAnother() {\r\n      this.createdBlade = null\r\n      this.qrContent = ''\r\n      this.form.blade_sn = ''\r\n    },\r\n    \r\n    viewTrace() {\r\n      if (this.createdBlade && this.createdBlade.blade_id) {\r\n        uni.navigateTo({\r\n          url: `/pages/trace-detail/trace-detail?bladeId=${this.createdBlade.blade_id}`\r\n        })\r\n      }\r\n    },\r\n    \r\n    getStatusText(status) {\r\n      return BLADE_STATUS_MAP[status] || status\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.create-container {\r\n  min-height: 100vh;\r\n  background: #FFFFFF;\r\n  padding: 20rpx;\r\n}\r\n\r\n.form-card {\r\n  background: #ffffff;\r\n  border-radius: 20rpx;\r\n  padding: 40rpx;\r\n}\r\n\r\n.card-title {\r\n  font-size: 36rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  margin-bottom: 30rpx;\r\n  text-align: center;\r\n}\r\n\r\n.form-section {\r\n  margin-bottom: 30rpx;\r\n}\r\n\r\n.input-group {\r\n  margin-bottom: 25rpx;\r\n}\r\n\r\n.input-label {\r\n  display: block;\r\n  font-size: 28rpx;\r\n  color: #666;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.input {\r\n  width: 100%;\r\n  height: 80rpx;\r\n  background: #f5f5f5;\r\n  border-radius: 8rpx;\r\n  padding: 0 20rpx;\r\n  font-size: 28rpx;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.submit-btn {\r\n  width: 100%;\r\n  height: 88rpx;\r\n  background: linear-gradient(135deg, #FFB6C1 0%, #FFB6C1 100%);\r\n  color: #ffffff;\r\n  border-radius: 10rpx;\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  border: none;\r\n  margin-top: 40rpx;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.submit-btn::after {\r\n  border: none;\r\n}\r\n\r\n.success-section {\r\n  margin-top: 40rpx;\r\n  padding-top: 40rpx;\r\n  border-top: 2rpx solid #e0e0e0;\r\n}\r\n\r\n.success-title {\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  color: #4caf50;\r\n  text-align: center;\r\n  margin-bottom: 30rpx;\r\n}\r\n\r\n.blade-info {\r\n  background: #f8f9fa;\r\n  border-radius: 10rpx;\r\n  padding: 20rpx;\r\n  margin-bottom: 30rpx;\r\n}\r\n\r\n.info-item {\r\n  display: flex;\r\n  margin-bottom: 15rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.info-item:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.info-item .label {\r\n  color: #666;\r\n  width: 180rpx;\r\n}\r\n\r\n.info-item .value {\r\n  color: #333;\r\n  font-weight: 500;\r\n}\r\n\r\n.qr-section {\r\n  text-align: center;\r\n  margin-bottom: 30rpx;\r\n}\r\n\r\n.qr-title {\r\n  font-size: 30rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.qr-content {\r\n  font-size: 24rpx;\r\n  color: #666;\r\n  margin-bottom: 20rpx;\r\n  font-family: 'Courier New', monospace;\r\n  background: #f5f5f5;\r\n  padding: 10rpx 20rpx;\r\n  border-radius: 8rpx;\r\n  display: inline-block;\r\n}\r\n\r\n.qrcode-canvas {\r\n  margin: 20rpx auto;\r\n  display: block;\r\n}\r\n\r\n.qr-tip {\r\n  font-size: 24rpx;\r\n  color: #999;\r\n  margin-top: 20rpx;\r\n}\r\n\r\n.action-buttons {\r\n  display: flex;\r\n  gap: 20rpx;\r\n  margin-top: 30rpx;\r\n}\r\n\r\n.action-btn {\r\n  flex: 1;\r\n  height: 80rpx;\r\n  border-radius: 10rpx;\r\n  font-size: 28rpx;\r\n  font-weight: bold;\r\n  border: none;\r\n}\r\n\r\n.action-btn.primary {\r\n  background: linear-gradient(135deg, #FFB6C1 0%, #FFB6C1 100%);\r\n  color: #ffffff;\r\n}\r\n\r\n.action-btn.secondary {\r\n  background: #f5f5f5;\r\n  color: #666;\r\n}\r\n\r\n.action-btn::after {\r\n  border: none;\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'D:/yepian32323232/yepian/叶片质量追溯/pages/blade-create/blade-create.vue'\nwx.createPage(MiniProgramPage)"],"names":["storage","uni","post","BLADE_STATUS_MAP"],"mappings":"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"}