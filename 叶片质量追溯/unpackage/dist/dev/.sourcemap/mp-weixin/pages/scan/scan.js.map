{"version":3,"file":"scan.js","sources":["pages/scan/scan.vue","F:/Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvc2Nhbi9zY2FuLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"scan-container\">\r\n    <view class=\"scan-area\">\r\n      <view class=\"scan-tips\">\r\n        <text>请将二维码放入框内扫描</text>\r\n      </view>\r\n      <button class=\"scan-btn\" @click=\"handleScan\" :loading=\"scanning\">\r\n        {{ scanning ? '扫描中...' : '开始扫描' }}\r\n      </button>\r\n    </view>\r\n    \r\n    <view class=\"manual-input\">\r\n      <view class=\"input-title\">或手动输入叶片ID</view>\r\n      <input \r\n        class=\"input\" \r\n        v-model=\"bladeIdInput\" \r\n        type=\"number\"\r\n        placeholder=\"请输入叶片ID\"\r\n      />\r\n      <button class=\"search-btn\" @click=\"handleManualInput\">\r\n        {{ mode === 'process-input' ? '录入工序' : '查询' }}\r\n      </button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport storage from '@/utils/storage.js'\r\nimport { parseQRContent } from '@/utils/qrcode.js'\r\nimport { get } from '@/utils/request.js'\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      scanning: false,\r\n      bladeIdInput: '',\r\n      userInfo: {},\r\n      mode: 'trace',  // trace: 追溯模式, process-input: 工序录入模式\r\n      processCode: null  // 如果指定了工序编码，则直接进入该工序录入\r\n    }\r\n  },\r\n  onLoad(options) {\r\n    const userInfo = storage.getUserInfo()\r\n    if (!userInfo) {\r\n      uni.reLaunch({\r\n        url: '/pages/login/login'\r\n      })\r\n      return\r\n    }\r\n    this.userInfo = userInfo\r\n    this.mode = options.mode || 'trace'\r\n    this.processCode = options.processCode || null\r\n    \r\n    // 设置导航栏标题\r\n    this.setNavigationTitle()\r\n    \r\n    // 如果是工序录入模式\r\n    if (this.mode === 'process-input') {\r\n      // 如果是荧光检测，允许质检员和管理员\r\n      if (this.processCode === 'FLUORESCENT_TEST') {\r\n        if (userInfo.role !== 'QC' && userInfo.role !== 'ADMIN') {\r\n          uni.showToast({\r\n            title: '只有质检员可以进行荧光检测',\r\n            icon: 'none'\r\n          })\r\n          setTimeout(() => {\r\n            uni.navigateBack()\r\n          }, 1500)\r\n          return\r\n        }\r\n      } else {\r\n        // 其他工序，只允许操作员和管理员\r\n        if (userInfo.role !== 'OPERATOR' && userInfo.role !== 'ADMIN') {\r\n          uni.showToast({\r\n            title: '只有操作员可以录入工序',\r\n            icon: 'none'\r\n          })\r\n          setTimeout(() => {\r\n            uni.navigateBack()\r\n          }, 1500)\r\n          return\r\n        }\r\n      }\r\n    }\r\n  },\r\n  onReady() {\r\n    // 在页面渲染完成后再次设置标题，确保生效\r\n    this.setNavigationTitle()\r\n  },\r\n  methods: {\r\n    setNavigationTitle() {\r\n      // 如果是工序录入模式\r\n      if (this.mode === 'process-input') {\r\n        // 如果是荧光检测，设置标题为\"荧光检测\"\r\n        if (this.processCode === 'FLUORESCENT_TEST') {\r\n          uni.setNavigationBarTitle({\r\n            title: '荧光检测'\r\n          })\r\n        } else {\r\n          // 其他工序录入，设置标题为\"工序录入\"\r\n          uni.setNavigationBarTitle({\r\n            title: '工序录入'\r\n          })\r\n        }\r\n      } else {\r\n        // 其他情况保持默认标题\"扫码追溯\"\r\n        uni.setNavigationBarTitle({\r\n          title: '扫码追溯'\r\n        })\r\n      }\r\n    },\r\n    handleScan() {\r\n      this.scanning = true\r\n      \r\n      uni.scanCode({\r\n        onlyFromCamera: true,\r\n        scanType: ['qrCode'],\r\n        success: (res) => {\r\n          this.scanning = false\r\n          console.log('扫码结果:', res.result)\r\n          this.processQRCode(res.result)\r\n        },\r\n        fail: (err) => {\r\n          this.scanning = false\r\n          console.error('扫码失败:', err)\r\n          uni.showToast({\r\n            title: '扫码失败，请重试',\r\n            icon: 'none'\r\n          })\r\n        }\r\n      })\r\n    },\r\n    \r\n    async processQRCode(qrContent) {\r\n      try {\r\n        console.log('扫码结果:', qrContent)\r\n        \r\n        // 解析二维码内容\r\n        const { bladeId, processIds } = parseQRContent(qrContent)\r\n        console.log('解析结果:', { bladeId, processIds })\r\n        \r\n        if (!bladeId) {\r\n          throw new Error('无法获取叶片ID')\r\n        }\r\n        \r\n        // 如果是工序录入模式\r\n        if (this.mode === 'process-input') {\r\n          // 跳转到工序录入页面\r\n          let url = `/pages/process-input/process-input?bladeId=${bladeId}`\r\n          if (this.processCode) {\r\n            url += `&processCode=${this.processCode}`\r\n          }\r\n          uni.navigateTo({\r\n            url: url\r\n          })\r\n          return\r\n        }\r\n        \r\n        // 如果是质检员，检查叶片状态，决定跳转到哪里\r\n        if (this.userInfo.role === 'QC' || this.userInfo.role === 'ADMIN') {\r\n          try {\r\n            const { get } = await import('@/utils/request.js')\r\n            const res = await get(`/blade/${bladeId}`)\r\n            \r\n            if (res && res.data && res.data.status === 'READY_FOR_QC') {\r\n              // 状态为待质检，直接跳转到质检录入页面\r\n              uni.navigateTo({\r\n                url: `/pages/qc-input/qc-input?bladeId=${bladeId}`\r\n              })\r\n              return\r\n            }\r\n          } catch (error) {\r\n            console.error('获取叶片信息失败:', error)\r\n            // 如果获取失败，继续跳转到追溯详情页\r\n          }\r\n        }\r\n        \r\n        // 跳转到追溯详情页（通过叶片ID查询数据库获取完整信息）\r\n        uni.navigateTo({\r\n          url: `/pages/trace-detail/trace-detail?bladeId=${bladeId}`\r\n        })\r\n      } catch (error) {\r\n        console.error('解析二维码失败:', error)\r\n        uni.showModal({\r\n          title: '二维码格式错误',\r\n          content: error.message || '无法解析二维码，请检查格式是否正确。\\n\\n支持的格式：\\n• B3（简单格式）\\n• B3|P1:1,2:2（完整格式）',\r\n          showCancel: false\r\n        })\r\n      }\r\n    },\r\n    \r\n    async handleManualInput() {\r\n      if (!this.bladeIdInput) {\r\n        uni.showToast({\r\n          title: '请输入叶片ID',\r\n          icon: 'none'\r\n        })\r\n        return\r\n      }\r\n      \r\n      const bladeId = parseInt(this.bladeIdInput)\r\n      if (!bladeId) {\r\n        uni.showToast({\r\n          title: '请输入有效的叶片ID',\r\n          icon: 'none'\r\n        })\r\n        return\r\n      }\r\n      \r\n      // 如果是工序录入模式\r\n      if (this.mode === 'process-input') {\r\n        let url = `/pages/process-input/process-input?bladeId=${bladeId}`\r\n        if (this.processCode) {\r\n          url += `&processCode=${this.processCode}`\r\n        }\r\n        uni.navigateTo({\r\n          url: url\r\n        })\r\n        return\r\n      }\r\n      \r\n      // 如果是质检员，检查叶片状态\r\n      if (this.userInfo.role === 'QC' || this.userInfo.role === 'ADMIN') {\r\n        try {\r\n          const res = await get(`/blade/${bladeId}`)\r\n          \r\n          if (res && res.data && res.data.status === 'READY_FOR_QC') {\r\n            // 状态为待质检，直接跳转到质检录入页面\r\n            uni.navigateTo({\r\n              url: `/pages/qc-input/qc-input?bladeId=${bladeId}`\r\n            })\r\n            return\r\n          }\r\n        } catch (error) {\r\n          console.error('获取叶片信息失败:', error)\r\n          // 如果获取失败，继续跳转到追溯详情页\r\n        }\r\n      }\r\n      \r\n      uni.navigateTo({\r\n        url: `/pages/trace-detail/trace-detail?bladeId=${bladeId}`\r\n      })\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.scan-container {\r\n  min-height: 100vh;\r\n  background: #FFFFFF;\r\n  padding: 40rpx 30rpx;\r\n}\r\n\r\n.scan-area {\r\n  background: #ffffff;\r\n  border-radius: 20rpx;\r\n  padding: 80rpx 40rpx;\r\n  text-align: center;\r\n  margin-bottom: 40rpx;\r\n}\r\n\r\n.scan-tips {\r\n  margin-bottom: 60rpx;\r\n}\r\n\r\n.scan-tips text {\r\n  font-size: 28rpx;\r\n  color: #666666;\r\n}\r\n\r\n.scan-btn {\r\n  width: 100%;\r\n  height: 88rpx;\r\n  background: linear-gradient(135deg, #FFB6C1 0%, #FFB6C1 100%);\r\n  color: #ffffff;\r\n  border-radius: 10rpx;\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  border: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.scan-btn::after {\r\n  border: none;\r\n}\r\n\r\n.manual-input {\r\n  background: #ffffff;\r\n  border-radius: 20rpx;\r\n  padding: 40rpx;\r\n}\r\n\r\n.input-title {\r\n  font-size: 28rpx;\r\n  color: #333333;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.input {\r\n  width: 100%;\r\n  height: 88rpx;\r\n  background: #f5f5f5;\r\n  border-radius: 10rpx;\r\n  padding: 0 30rpx;\r\n  font-size: 28rpx;\r\n  margin-bottom: 30rpx;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.search-btn {\r\n  width: 100%;\r\n  height: 88rpx;\r\n  background: #FFB6C1;\r\n  color: #ffffff;\r\n  border-radius: 10rpx;\r\n  font-size: 32rpx;\r\n  border: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.search-btn::after {\r\n  border: none;\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'D:/yepian3/yepian/叶片质量追溯/pages/scan/scan.vue'\nwx.createPage(MiniProgramPage)"],"names":["storage","uni","parseQRContent","get"],"mappings":"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"}