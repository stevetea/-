# 已完成所有工序叶片的权限控制说明

## 一、权限控制原则

**核心原则：只有质检员能决定已完成所有工序的叶片的状态**

- ✅ 操作员（OPERATOR）：**不能**对 `READY_FOR_QC` 状态的叶片进行任何操作
- ✅ 质检员（QC）：**可以**对 `READY_FOR_QC` 状态的叶片进行质检操作
- ✅ 管理员（ADMIN）：**可以**对 `READY_FOR_QC` 状态的叶片进行操作（包括质检和返工）

## 二、后端权限控制

### 1. 工序录入接口（POST /api/process）

**位置**：`backend/routes/process.js` 第62-78行

```javascript
// 权限检查：已完成所有工序的叶片（READY_FOR_QC），只有质检员和管理员可以操作
if (bladeStatus === 'READY_FOR_QC') {
  if (userRole !== 'QC' && userRole !== 'ADMIN') {
    return res.status(403).json({
      code: 403,
      message: '该叶片已完成所有工序，只有质检员可以操作'
    });
  }
}

// 已完成或报废的叶片不能再录入工序
if (bladeStatus === 'COMPLETED' || bladeStatus === 'SCRAPPED') {
  return res.status(400).json({
    code: 400,
    message: `该叶片状态为${bladeStatus === 'COMPLETED' ? '已完成' : '已报废'}，无法继续录入工序`
  });
}
```

**控制逻辑：**
- ✅ 如果叶片状态为 `READY_FOR_QC`，只有质检员和管理员可以录入工序
- ❌ 操作员尝试对 `READY_FOR_QC` 状态的叶片录入工序时，返回 403 错误
- ❌ 已完成或报废的叶片不能再录入工序

### 2. 质检接口（POST /api/qc）

**位置**：`backend/routes/qc.js` 第14行

```javascript
router.post('/', authenticateToken, checkRole('QC', 'ADMIN'), async (req, res) => {
  // 只有质检员和管理员可以提交质检报告
  // 检查叶片状态必须为 READY_FOR_QC
  if (blades[0].status !== 'READY_FOR_QC') {
    return res.status(400).json({
      code: 400,
      message: '该叶片尚未完成所有工序，无法进行质检'
    });
  }
})
```

**控制逻辑：**
- ✅ 只有质检员和管理员可以提交质检报告
- ✅ 只有 `READY_FOR_QC` 状态的叶片可以进行质检
- ✅ 质检结果决定叶片最终状态（COMPLETED 或 SCRAPPED）

## 三、前端权限控制

### 1. 工序录入页面（process-input.vue）

**位置**：`pages/process-input/process-input.vue` 第236-270行

```javascript
async loadBladeInfo() {
  try {
    const res = await get(`/blade/${this.bladeId}`)
    if (res && res.data) {
      this.bladeInfo = res.data
      
      // 检查权限：已完成所有工序的叶片，只有质检员可以操作
      const userInfo = storage.getUserInfo()
      if (res.data.status === 'READY_FOR_QC') {
        if (userInfo.role !== 'QC' && userInfo.role !== 'ADMIN') {
          uni.showModal({
            title: '权限不足',
            content: '该叶片已完成所有工序，只有质检员可以进行操作',
            showCancel: false,
            success: () => {
              uni.navigateBack()
            }
          })
          return
        }
      }
      
      // 已完成或报废的叶片不能再录入工序
      if (res.data.status === 'COMPLETED' || res.data.status === 'SCRAPPED') {
        uni.showModal({
          title: '提示',
          content: `该叶片状态为${res.data.status === 'COMPLETED' ? '已完成' : '已报废'}，无法继续录入工序`,
          showCancel: false,
          success: () => {
            uni.navigateBack()
          }
        })
        return
      }
    }
  } catch (error) {
    console.error('加载叶片信息失败:', error)
  }
}
```

**控制逻辑：**
- ✅ 页面加载时检查叶片状态
- ❌ 操作员访问 `READY_FOR_QC` 状态的叶片时，显示权限不足提示并返回
- ❌ 已完成或报废的叶片显示提示并返回

### 2. 质检录入页面（qc-input.vue）

**位置**：`pages/qc-input/qc-input.vue` 第198-209行

```javascript
onLoad(options) {
  // 检查权限
  const userInfo = storage.getUserInfo()
  if (!userInfo || (userInfo.role !== 'QC' && userInfo.role !== 'ADMIN')) {
    uni.showToast({
      title: '无权限访问',
      icon: 'none'
    })
    setTimeout(() => {
      uni.navigateBack()
    }, 1500)
    return
  }
}
```

**控制逻辑：**
- ✅ 只有质检员和管理员可以访问质检录入页面
- ✅ 只有 `READY_FOR_QC` 状态的叶片可以录入质检报告

## 四、权限控制矩阵

| 叶片状态 | 操作员（OPERATOR） | 质检员（QC） | 管理员（ADMIN） |
|---------|------------------|-------------|----------------|
| `NEW` | ✅ 可以录入工序 | ✅ 可以录入工序 | ✅ 可以录入工序 |
| `IN_PROCESS` | ✅ 可以录入工序 | ✅ 可以录入工序 | ✅ 可以录入工序 |
| `BLOCKED` | ✅ 可以返工 | ✅ 可以返工 | ✅ 可以返工 |
| `READY_FOR_QC` | ❌ **不能操作** | ✅ 可以质检 | ✅ 可以质检/返工 |
| `COMPLETED` | ❌ 不能操作 | ❌ 不能操作 | ❌ 不能操作 |
| `SCRAPPED` | ❌ 不能操作 | ❌ 不能操作 | ❌ 不能操作 |

## 五、状态转换权限

### 1. 从 READY_FOR_QC 转换

**只有质检员可以决定：**

```
READY_FOR_QC（待质检）
    ↓
[质检员进行质检]
    ↓
┌───────────┴───────────┐
↓                       ↓
COMPLETED           SCRAPPED
（完成）              （报废）
```

**操作员不能：**
- ❌ 不能对 `READY_FOR_QC` 状态的叶片录入工序
- ❌ 不能改变 `READY_FOR_QC` 状态的叶片状态

**质检员可以：**
- ✅ 对 `READY_FOR_QC` 状态的叶片进行质检
- ✅ 通过质检决定叶片最终状态（COMPLETED 或 SCRAPPED）
- ✅ 如果需要返工，可以录入工序（状态会变成 IN_PROCESS）

### 2. 其他状态转换

- `NEW` → `IN_PROCESS`：所有角色都可以（录入工序成功）
- `IN_PROCESS` → `BLOCKED`：所有角色都可以（录入工序失败）
- `BLOCKED` → `IN_PROCESS`：所有角色都可以（返工成功）
- `IN_PROCESS` → `READY_FOR_QC`：系统自动（完成所有工序）

## 六、实现细节

### 1. 后端检查时机

- ✅ **工序录入接口**：在检查叶片存在后，立即检查状态和权限
- ✅ **质检接口**：通过 `checkRole('QC', 'ADMIN')` 中间件限制角色

### 2. 前端检查时机

- ✅ **页面加载时**：在 `onLoad` 和 `loadBladeInfo` 中检查
- ✅ **数据加载时**：在获取叶片信息后立即检查状态

### 3. 错误处理

- ✅ 后端返回明确的错误信息（403 权限不足）
- ✅ 前端显示友好的提示信息
- ✅ 自动返回上一页，避免用户困惑

## 七、测试场景

### 场景1：操作员尝试对已完成工序的叶片录入工序

1. **操作员登录**
2. **扫描已完成所有工序的叶片**（状态：READY_FOR_QC）
3. **尝试录入工序**
4. **结果**：
   - 后端返回 403 错误："该叶片已完成所有工序，只有质检员可以操作"
   - 前端显示权限不足提示并返回

### 场景2：质检员对已完成工序的叶片进行质检

1. **质检员登录**
2. **选择已完成所有工序的叶片**（状态：READY_FOR_QC）
3. **进行质检录入**
4. **提交质检报告**
5. **结果**：
   - 系统更新叶片状态为 COMPLETED 或 SCRAPPED
   - 只有质检员可以决定最终状态

### 场景3：操作员正常录入工序

1. **操作员登录**
2. **扫描加工中的叶片**（状态：IN_PROCESS 或 NEW）
3. **录入工序**
4. **结果**：
   - 正常录入，系统更新状态
   - 不受权限限制

## 八、关键代码位置

- **后端权限检查**：`backend/routes/process.js` 第62-78行
- **前端权限检查**：`pages/process-input/process-input.vue` 第236-270行
- **质检权限控制**：`backend/routes/qc.js` 第14行
- **说明文档**：已创建 `权限控制说明.md`

## 九、总结

**权限控制核心：**

1. ✅ **操作员不能**对 `READY_FOR_QC` 状态的叶片进行任何操作
2. ✅ **只有质检员**可以通过质检决定已完成所有工序的叶片状态
3. ✅ **管理员**拥有所有权限，包括质检和返工
4. ✅ **前后端双重检查**，确保权限控制有效

**状态转换权限：**

- `READY_FOR_QC` → `COMPLETED`：只有质检员可以（通过质检）
- `READY_FOR_QC` → `SCRAPPED`：只有质检员可以（通过质检）
- 其他状态转换：所有角色都可以（根据业务规则）

